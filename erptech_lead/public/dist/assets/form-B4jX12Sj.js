import{a as n,j as e,C as B,B as u,q as me,s as xe,t as H,v as h,w as pe,x as f,p as te,k as T,J as K,I as L,U as re,A as le,e as he,u as fe,l as ye,y as ke,S as be,z as oe,D as Q}from"./index-CA5hYvF4.js";import{u as je,o as Ne}from"./index.esm-CfaYpkcJ.js";import{F as Y,S as U,a as ne,b as ve,D as de}from"./dynamicForms-BWj5Mv9o.js";import{P as _e}from"./Page-DRGXT54w.js";import{c as se,a as we,b as Ce,d as De,u as Se,e as Fe}from"./useApiHook-BFrwdBxT.js";import{F as ue,C as Ae}from"./CarProfiles-Dl12Jr3F.js";import{z as Z,F}from"./transition-DepUEpKq.js";import{y as ee,j as ae}from"./iconBase-BjazxlP7.js";import{C as Oe}from"./ConfirmModal-DqhhJs29.js";import{F as Pe,a as Te}from"./TrashIcon-qOgpfnZc.js";import{F as Ee}from"./DocumentPlusIcon-DSw2BGEv.js";import"./Datepicker-CsEuZ0ZS.js";import"./combobox-BBGGeSuq.js";import"./use-by-comparator-BwwcpCm_.js";import"./hidden-Ch8UUVwr.js";import"./active-element-history-Co1KpUKB.js";import"./calculate-active-index-BvHaOcpL.js";import"./use-tree-walker-CR9N67HP.js";import"./frozen-D9HBBuQ3.js";import"./label-CzOfrsQP.js";import"./useMutation-B9i3jLXB.js";import"./floating-ui.dom-CtcSe9Ld.js";function Me({id:d,data:t,setValue:A,refetchData:b}){var _;const[v,o]=n.useState(!1),[l,g]=n.useState({description:"",next_date:"",created_date:new Date().toISOString().split("T")[0]}),c=se(r=>{r&&v&&(o(!1),b())}),C=()=>{if(l.description&&l.description.trim()&&l.next_date){const r=(t==null?void 0:t.custom_followup_history)||[],y=[...r,{...l,idx:r.length+1}];c.mutate({doctype:"Lead",body:{id:d,custom_followup_history:y,custom_next_follow_up_date:l.next_date,custom_lead_status:"Call Back"}}),A("custom_followup_history",y),g({description:"",next_date:"",created_date:new Date().toISOString().split("T")[0]})}};return d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"col-span-12 lg:col-span-12",children:e.jsx(B,{className:"p-4 sm:px-5",children:e.jsxs("div",{className:"mt-5 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Follow-up History Records"}),e.jsxs(u,{onClick:()=>o(!0),color:"primary",className:"flex items-center gap-2",children:[e.jsx(ue,{className:"size-4"}),"Add New Record"]})]}),t!=null&&t.custom_followup_history&&((_=t==null?void 0:t.custom_followup_history)==null?void 0:_.length)>0?e.jsx("div",{className:"hide-scrollbar overflow-x-auto",children:e.jsxs(me,{hoverable:!0,className:"w-full min-w-[600px] text-left rtl:text-right",children:[e.jsx(xe,{children:e.jsxs(H,{className:"border-y border-transparent border-b-gray-200 dark:border-b-dark-500",children:[e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"#"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Created Date"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Description"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Next Follow-up Date"})]})}),e.jsx(pe,{children:t==null?void 0:t.custom_followup_history.map((r,y)=>e.jsxs(H,{className:"border-b border-gray-200 dark:border-dark-500",children:[e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:y+1}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:r.created_date?new Date(r.created_date).toLocaleDateString():"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:r.description||"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:r.next_date?new Date(r.next_date).toLocaleDateString():"-"})]},y))})]})}):e.jsx("div",{className:"flex flex-col items-center justify-center py-12",children:e.jsx("p",{className:"text-gray-500 dark:text-dark-300",children:'No follow-up records yet. Click "Add New Record" to add one.'})})]})})}),e.jsxs(Z,{appear:!0,show:v,as:ee,onClose:()=>o(!1),children:[e.jsx(F,{as:"div",enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",className:"fixed inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"}),e.jsx(F,{as:ae,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"fixed inset-0 z-100 flex items-center justify-center overflow-hidden px-4 py-6 sm:px-5",children:e.jsxs("div",{className:"scrollbar-sm relative flex w-full max-w-lg flex-col rounded-lg bg-white transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Add Follow-up History"}),e.jsx("button",{onClick:()=>o(!1),className:"rounded-lg p-1.5 hover:bg-gray-100 dark:hover:bg-dark-600",children:e.jsx(Y,{className:"size-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["Description ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:l.description,onChange:r=>g({...l,description:r.target.value}),placeholder:"Enter follow-up description...",rows:"4",className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Created Date"}),e.jsx("input",{type:"date",value:l.created_date,onChange:r=>g({...l,created_date:r.target.value}),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["Next Follow-up Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:l.next_date,onChange:r=>g({...l,next_date:r.target.value}),className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50",required:!0})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx(u,{variant:"outlined",onClick:()=>{o(!1),g({description:"",next_date:"",created_date:new Date().toISOString().split("T")[0]})},children:"Cancel"}),e.jsx(u,{color:"primary",onClick:C,disabled:!l.description||!l.description.trim()||!l.next_date,children:"Add Record"})]})]})})]})]}):null}function ze({id:d,data:t}){const[A,b]=n.useState(!1),[v,o]=n.useState(!1),[l,g]=n.useState(null),[c,C]=n.useState(!1),[_,r]=n.useState(null),[y,E]=n.useState([]),[O,M]=n.useState([]),[s,i]=n.useState({lead:d||"",customer:(t==null?void 0:t.customer)||"",car_profile:"",approval_manager:"",policy_name:"",policy_amount:"",status:"Waiting",type:"New",file_attachment:"",comments:""}),[z,R]=n.useState({doctype:"COD Management",page:1,page_length:100,fields:JSON.stringify(["name","lead","customer","car_profile","approval_manager","policy_name","policy_amount","status","file_attachment","comments","creation","modified"]),filters:d?JSON.stringify([["lead","=",d],["type","=","New"]]):null}),{data:w,isFetching:$,refetch:P}=we(z);n.useEffect(()=>{d&&(te({doctype:"Car Profile",fields:JSON.stringify(["name","car_make","car_model","car_year"]),filters:JSON.stringify([["lead","=",d],["status","=","New"]]),page_length:100}).then(a=>{if(a!=null&&a.data){const p=a.data.map(k=>({label:`${k.car_make||""} ${k.car_model||""} ${k.car_year||""}`.trim()||k.name,value:k.name}));E(p)}}),te({doctype:"User",fields:JSON.stringify(["name","full_name"]),filters:JSON.stringify([["role_profile_name","=","Lead User"]]),page_length:100}).then(a=>{if(a!=null&&a.data){const p=a.data.map(k=>({label:`${k.full_name||""}`.trim()||k.name,value:k.name}));M(p)}}))},[d]),n.useEffect(()=>{d&&R(a=>({...a,filters:JSON.stringify([["lead","=",d],["type","=","New"]])}))},[d]),n.useEffect(()=>{w!=null&&w.data?j(w.data):j([])},[w]);const[m,j]=n.useState([]),N=Ce(a=>{a&&(b(!1),x(),P())}),D=se(a=>{a&&(o(!1),g(null),x(),P())}),S=De(a=>{a&&a.success&&(C(!1),r(null),P())}),x=()=>{i({lead:d||"",customer:(t==null?void 0:t.customer)||"",car_profile:"",approval_manager:"",policy_name:"",policy_amount:"",status:"Waiting",type:"New",file_attachment:"",comments:""})},I=()=>{s.file_attachment&&N.mutate({doctype:"COD Management",body:s})},W=a=>{const p=m.find(k=>k.name===a);p&&(i({lead:p.lead||d||"",customer:p.customer||(t==null?void 0:t.customer)||"",car_profile:p.car_profile||"",approval_manager:p.approval_manager||"",policy_name:p.policy_name||"",policy_amount:p.policy_amount||"",status:p.status||"Waiting",file_attachment:p.file_attachment||"",comments:p.comments||""}),g(a),o(!0))},V=()=>{l&&s.file_attachment&&D.mutate({doctype:"COD Management",body:{...s,id:l}})},G=a=>{r(a),C(!0)},ge=()=>{_&&S.mutate({doctype:"COD Management",ids:[_]})};return n.useEffect(()=>{t!=null&&t.customer&&i(a=>({...a,customer:t.customer}))},[t==null?void 0:t.customer]),d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"col-span-12 lg:col-span-12",children:e.jsx(B,{className:"p-4 sm:px-5",children:e.jsxs("div",{className:"mt-5 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"COD Document Approvals"}),e.jsxs(u,{onClick:()=>{x(),b(!0)},color:"primary",className:"flex items-center gap-2",children:[e.jsx(ue,{className:"size-4"}),"Approvals Request"]})]}),$?e.jsx("div",{className:"py-4 text-center text-sm text-gray-500",children:"Loading COD documents..."}):m&&m.length>0?e.jsx("div",{className:"mt-6",children:e.jsx("div",{className:"hide-scrollbar overflow-x-auto",children:e.jsxs(me,{hoverable:!0,className:"w-full min-w-[900px] text-left rtl:text-right",children:[e.jsx(xe,{children:e.jsxs(H,{className:"border-y border-transparent border-b-gray-200 dark:border-b-dark-500",children:[e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Customer"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Car Profile"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Policy Name"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Policy Amount"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Status"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Approval Manager"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"File Attachment"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Comments"}),e.jsx(h,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Actions"})]})}),e.jsx(pe,{children:m.map(a=>e.jsxs(H,{className:"border-b border-gray-200 dark:border-dark-500",children:[e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.customer||"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.car_profile||"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.policy_name||"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.policy_amount?`AED ${parseFloat(a.policy_amount).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:e.jsx("span",{className:T("inline-flex rounded-full px-2 py-1 text-xs font-semibold",a.status==="Approve"&&"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",a.status==="Decline"&&"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",a.status==="Waiting"&&"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400"),children:a.status||"-"})}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.approval_manager||"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.file_attachment?e.jsx("a",{href:`${K}${a.file_attachment}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline dark:text-blue-400",children:"View File"}):"-"}),e.jsx(f,{className:"text-gray-700 dark:text-dark-200",children:a.comments||"-"}),e.jsx(f,{children:a.status!=="Approve"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{size:"sm",variant:"outlined",onClick:()=>W(a.name),className:"p-1.5",children:e.jsx(Pe,{className:"size-4"})}),e.jsx(u,{size:"sm",variant:"outlined",color:"error",onClick:()=>G(a.name),className:"p-1.5",disabled:S.isPending,children:e.jsx(Te,{className:"size-4"})})]})})]},a.name))})]})})}):e.jsx("div",{className:"flex flex-col items-center justify-center py-12",children:e.jsx("p",{className:"text-gray-500 dark:text-dark-300",children:'No COD documents yet. Click "Add New Record" to add one.'})})]})})}),e.jsxs(Z,{appear:!0,show:A,as:ee,onClose:()=>{b(!1),x()},children:[e.jsx(F,{as:"div",enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",className:"fixed inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"}),e.jsx(F,{as:ae,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"fixed inset-0 z-100 flex items-center justify-center overflow-hidden px-4 py-6 sm:px-5",children:e.jsxs("div",{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col rounded-lg bg-white transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Add Approvals Request"}),e.jsx("button",{onClick:()=>{b(!1),x()},className:"rounded-lg p-1.5 hover:bg-gray-100 dark:hover:bg-dark-600",children:e.jsx(Y,{className:"size-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(U,{label:"Car Profile",lists:y,value:s.car_profile,onChange:a=>i({...s,car_profile:a||""}),placeholder:"Select Car Profile",req:!0})}),e.jsx("div",{children:e.jsx(U,{label:"Approval Manager",lists:O,value:s.approval_manager,onChange:a=>i({...s,approval_manager:a||""}),placeholder:"Select Approval Manager",req:!0})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["Policy Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(L,{value:s.policy_name,onChange:a=>i({...s,policy_name:a.target.value}),placeholder:"Enter Policy Name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Amount"}),e.jsx(L,{type:"number",value:s.policy_amount,onChange:a=>i({...s,policy_amount:a.target.value}),placeholder:"Enter Policy Amount",step:"0.01",min:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["File Attachment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(re,{onChange:a=>{a&&i({...s,file_attachment:a})},children:({...a})=>e.jsxs(u,{...a,unstyled:!0,className:T("mt-3 w-full shrink-0 flex-col rounded-lg border-2 border-dashed py-10 border-gray-300 dark:border-dark-450"),children:[e.jsx(ne,{className:"size-12"}),e.jsxs("span",{className:T("pointer-events-none mt-2 text-gray-600 dark:text-dark-200"),children:[e.jsx("span",{className:"text-primary-600 dark:text-primary-400",children:"Browse"}),e.jsx("span",{children:" or drop your files here"})]}),s.file_attachment&&e.jsx("span",{className:"mt-2 text-sm text-gray-500 dark:text-dark-300",children:"File selected"})]})}),s.file_attachment&&e.jsx("div",{className:"mt-2 flex flex-col space-y-4",children:e.jsx("div",{className:"relative inline-block",children:e.jsx(le,{size:24,src:`${K}${s.file_attachment}`,classNames:{display:"rounded-lg"}})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Comments"}),e.jsx("textarea",{value:s.comments,onChange:a=>i({...s,comments:a.target.value}),placeholder:"Enter comments...",rows:"3",className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50"})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx(u,{variant:"outlined",onClick:()=>{b(!1),x()},children:"Cancel"}),e.jsx(u,{color:"primary",onClick:I,disabled:!s.file_attachment||N.isPending,children:N.isPending?"Adding...":"Add Document"})]})]})})]}),e.jsxs(Z,{appear:!0,show:v,as:ee,onClose:()=>{o(!1),g(null),x()},children:[e.jsx(F,{as:"div",enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",className:"fixed inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"}),e.jsx(F,{as:ae,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"fixed inset-0 z-100 flex items-center justify-center overflow-hidden px-4 py-6 sm:px-5",children:e.jsxs("div",{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col rounded-lg bg-white transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Edit COD Document"}),e.jsx("button",{onClick:()=>{o(!1),g(null),x()},className:"rounded-lg p-1.5 hover:bg-gray-100 dark:hover:bg-dark-600",children:e.jsx(Y,{className:"size-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(U,{label:"Car Profile",lists:y,value:s.car_profile,onChange:a=>i({...s,car_profile:a||""}),placeholder:"Select Car Profile"})}),e.jsx("div",{children:e.jsx(U,{label:"Approval Manager",lists:O,value:s.approval_manager,onChange:a=>i({...s,approval_manager:a||""}),placeholder:"Select Approval Manager"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Name"}),e.jsx(L,{value:s.policy_name,onChange:a=>i({...s,policy_name:a.target.value}),placeholder:"Enter Policy Name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Amount"}),e.jsx(L,{type:"number",value:s.policy_amount,onChange:a=>i({...s,policy_amount:a.target.value}),placeholder:"Enter Policy Amount",step:"0.01",min:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["File Attachment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(re,{onChange:a=>{a&&i({...s,file_attachment:a})},children:({...a})=>e.jsxs(u,{...a,unstyled:!0,className:T("mt-3 w-full shrink-0 flex-col rounded-lg border-2 border-dashed py-10 border-gray-300 dark:border-dark-450"),children:[e.jsx(ne,{className:"size-12"}),e.jsxs("span",{className:T("pointer-events-none mt-2 text-gray-600 dark:text-dark-200"),children:[e.jsx("span",{className:"text-primary-600 dark:text-primary-400",children:"Browse"}),e.jsx("span",{children:" or drop your files here"})]}),s.file_attachment&&e.jsx("span",{className:"mt-2 text-sm text-gray-500 dark:text-dark-300",children:"File selected"})]})}),s.file_attachment&&e.jsx("div",{className:"mt-2 flex flex-col space-y-4",children:e.jsx("div",{className:"relative inline-block",children:e.jsx(le,{size:24,src:`${K}${s.file_attachment}`,classNames:{display:"rounded-lg"}})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Comments"}),e.jsx("textarea",{value:s.comments,onChange:a=>i({...s,comments:a.target.value}),placeholder:"Enter comments...",rows:"3",className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50"})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx(u,{variant:"outlined",onClick:()=>{o(!1),g(null),x()},children:"Cancel"}),e.jsx(u,{color:"primary",onClick:V,disabled:!s.file_attachment||D.isPending,children:D.isPending?"Updating...":"Update Document"})]})]})})]}),e.jsx(Oe,{show:c,onClose:()=>{C(!1),r(null)},onOk:ge,confirmLoading:S.isPending,state:S.isError?"error":"pending",messages:{pending:{title:"Delete COD Document?",description:"Are you sure you want to delete this COD document? This action cannot be undone.",actionText:"Delete"}}})]}):null}const ie="Lead",X="Lead",J=["first_name","last_name","email_id","mobile_no"],q=["custom_assigned_user","custom_lead_status","custom_next_follow_up_date","source","custom_followup_history"],ce={ignorFields:{status:!0,custom_followup_history:!0}};function la(){const{user:{username:d}}=he(),{isDark:t,darkColorScheme:A,lightColorScheme:b}=fe(),v=ye(),{id:o}=ke(),{data:l,isFetching:g}=Se({doctype:X,fields:JSON.stringify([...J,...q])}),{data:c,isFetching:C,refetch:_}=Fe({doctype:X,id:o,fields:JSON.stringify([...J,...q])}),[r,y]=n.useState([]),[E,O]=n.useState(!1),M=se(m=>{m&&(w(),v(-1))}),{register:s,handleSubmit:i,formState:{errors:z},control:R,reset:w,setValue:$}=je({resolver:Ne(ve(l==null?void 0:l.fields,["status"])),values:o?c:{},defaultValues:Object.fromEntries([...J,...q].map(m=>[m,""]))}),P=async m=>{if(o){const j={...m};M.mutate({doctype:X,body:{...j,id:o}})}else{if(!r||r.length===0){oe({message:"Please add at least one Car Profile before creating the lead."});return}O(!0);try{const j={customer_name:`${m.first_name||""} ${m.last_name||""}`.trim()||"Customer",customer_type:"Individual",email_id:m.email_id||"",mobile_no:m.mobile_no||""},N=await Q({doctype:"Customer",body:j});if(!N||!N.name&&!N.id)throw new Error("Failed to create customer");const D=N.name||N.id,S={...m,customer:D,status:"Open",custom_assigned_user:d,custom_lead_status:"New"},x=await Q({doctype:"Lead",body:S});if(!x||!x.name&&!x.id)throw new Error("Failed to create lead");const I=x.name||x.id;M.mutate({doctype:"Customer",body:{lead_name:I,id:D}});const W=r.map(V=>{const G={...V,customer:D,lead:I,status:"New"};return Q({doctype:"Car Profile",body:G})});await Promise.all(W),w(),y([]),v(-1)}catch(j){console.error("Error creating lead:",j),oe(j)}finally{O(!1)}}};return g||C?e.jsx(be,{style:{"--sk-color":t?A[700]:b[300]}}):e.jsx(_e,{title:(o?"Edit ":"New ")+ie,children:e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ee,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[o?"Edit":"New"," ",ie]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>v(-1),children:"Back"}),e.jsx(u,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",disabled:E,children:E?"Creating...":"Save"})]})]}),e.jsxs("form",{autoComplete:"off",onSubmit:i(P),id:"new-post-form",children:[e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[e.jsx(ze,{id:o,data:c,setValue:$,refetchData:_}),e.jsx(Me,{id:o,data:c,setValue:$,refetchData:_}),e.jsx("div",{className:"col-span-12 lg:col-span-7",children:e.jsx(B,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:e.jsx(de,{infos:l,fields:J,register:s,tables:ce,control:R,errors:z})})})}),e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-5 lg:space-y-6",children:e.jsx(B,{className:"p-4 sm:px-5",children:e.jsx(de,{infos:l,tables:ce,fields:q,register:s,control:R,errors:z,readOnlyFields:["custom_lead_status","custom_next_follow_up_date"]})})})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Ae,{leadId:o,customerId:c==null?void 0:c.customer,leadName:(c==null?void 0:c.lead_name)||(c==null?void 0:c.name),isCreateMode:!o,carProfilesToCreate:r,setCarProfilesToCreate:y})})]})]})})}export{la as default};
