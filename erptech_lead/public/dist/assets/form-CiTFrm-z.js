import{a as r,u as ye,n as Ne,I as be,j as e,S as we,B as V,C as je,N as y}from"./index-DbfsOBPs.js";import{u as _e,o as ve,a as I,C as b}from"./index.esm-BlpO5D5p.js";import{S as Se,a as w}from"./SearchSelect-B4wBJHlo.js";import{P as Oe}from"./Page-C35G2W2r.js";import{c as xe,a as De,u as We,d as Te}from"./useApiHook-NhieA4nr.js";import{F as Ie}from"./DocumentPlusIcon-DAMkd652.js";import"./combobox-zvBiAmuC.js";import"./transition-Dq2NZXOC.js";import"./floating-ui.dom-CtcSe9Ld.js";import"./frozen-Dku1HT9_.js";import"./active-element-history-D5w9w6cL.js";import"./Datepicker-CuwpZe0b.js";import"./popover-BNv0rLk5.js";import"./index-CVvjpFk0.js";import"./iconBase-DndNKKp1.js";import"./ConfirmModal-D7zucHRa.js";import"./XMarkIcon-D_xaI-y6.js";import"./useUnmount-ByjWHt2P.js";import"./useMutation-BX4jn18I.js";const Ee=(D,pe,ue,c)=>{const[u,x]=r.useState(!1),[z,n]=r.useState(!0),[J,v]=r.useState(!0),[K,m]=r.useState(!1),[U,$]=r.useState([]),[d,W]=r.useState([]),[g,G]=r.useState([]),[T,q]=r.useState([]),[L,P]=r.useState([]),[R,M]=r.useState([]),[H,Q]=r.useState([]),[X,Y]=r.useState([]),[Z,ee]=r.useState([]),[se,he]=r.useState(!D),[S,te]=r.useState(""),[ae,re]=r.useState(!1),[j,O]=r.useState(null),[B,ge]=r.useState(null),[le,ie]=r.useState(null),{data:N}=xe({doctype:"RMC Settings",id:"enable_weigh_scale",fields:JSON.stringify(["enable_weigh_scale","baud_rate","split_character"])});r.useEffect(()=>{if(c!=null&&c.fields){const l=c.fields.find(t=>t.fieldname==="wbslip_type");if(l!=null&&l.options){const t=l.options.split(`
`).map(i=>({label:i,value:i}));W(t)}const f=c.fields.find(t=>t.fieldname==="deduct_reason");if(f!=null&&f.options){const t=f.options.split(`
`).map(i=>({label:i,value:i}));G(t)}const o=c.fields.find(t=>t.fieldname==="item");o!=null&&o.options_list&&$(o.options_list);const p=c.fields.find(t=>t.fieldname==="purchase_order");p!=null&&p.options_list&&q(p.options_list);const s=c.fields.find(t=>t.fieldname==="supplier_name");if(s!=null&&s.options_list){const t=s.options.split(`
`).map(i=>({label:i,value:i}));P(t)}const a=c.fields.find(t=>t.fieldname==="transporter");if(a!=null&&a.options){const t=a.options.split(`
`).map(i=>({label:i,value:i}));M(t)}const h=c.fields.find(t=>t.fieldname==="delivery_note");if(h!=null&&h.options){const t=h.options.split(`
`).map(i=>({label:i,value:i}));Q(t)}const _=c.fields.find(t=>t.fieldname==="customer_name");if(_!=null&&_.options){const t=_.options.split(`
`).map(i=>({label:i,value:i}));Y(t)}const A=c.fields.find(t=>t.fieldname==="vehicle");if(A!=null&&A.options){const t=A.options.split(`
`).map(i=>({label:i,value:i}));ee(t)}}},[c]);const E=async(l,f)=>{const o=new TextDecoderStream;l.readable.pipeTo(o.writable);const p=o.readable.getReader();let s=0;for(;;)try{const{value:a,done:h}=await p.read();if(h){p.releaseLock();break}let _=String(a).includes(f.split_character)?String(a).replace(f.split_character,""):String(a);s!==Number(_)&&(s=Number(_),te(String(Number(_))))}catch(a){console.error("Error reading from serial port:",a);break}};return r.useEffect(()=>{let l=null;return(async()=>{if(re(!0),"serial"in navigator&&N)try{const o=await navigator.serial.getPorts();if(o.length===0){const p=await navigator.serial.requestPort();await p.open({baudRate:Number(N.baud_rate)}),O(p),await E(p,N)}else await o[0].open({baudRate:Number(N.message.baud_rate)}),O(o[0]),await E(o[0],N)}catch(o){console.log("Serial port connection failed, using test mode:",o)}else console.log("Browser does not support serial device connection")})(),()=>{}},[D,N]),r.useEffect(()=>()=>{if(j)try{j.close()}catch(l){console.error("Error closing serial port:",l)}},[j]),{isGrossDisabled:u,isTareDisabled:z,showInward:J,showOutward:K,itemOptions:U,wbslipTypeOptions:d,deductReasonOptions:g,purchaseOrderOptions:T,supplierOptions:L,transporterOptions:R,deliveryNoteOptions:H,customerOptions:X,vehicleOptions:Z,isNewRecord:se,displayData:S,isWeighScaleEnabled:ae,serialPort:j,rmcSettings:N,purchaseOrderData:B,deliveryNoteData:le,handleWBSlipTypeChange:l=>{l?l==="Inward"?(v(!0),m(!1),x(!1),n(!0)):l==="Outward"?(v(!1),m(!0),x(!0),n(!1)):l==="Other"&&(v(!0),m(!0),x(!1),n(!1)):(v(!0),m(!1),x(!1),n(!0))},handleGrossWeight:l=>{S&&(l("gross_weight",S),l("gross_weight_date_time",new Date().toISOString().slice(0,19).replace("T"," ")),x(!0))},handleTareWeight:l=>{S&&(l("tare_weight",S),l("tare_weight_date_time",new Date().toISOString().slice(0,19).replace("T"," ")),n(!0))},calculateWeight:(l,f,o,p)=>{if(l&&f){const s=parseFloat(l)-parseFloat(f);p("net_weight",s.toString());const a=(parseFloat(o)||0)/100*s;p("grand_net_weight",(s-a).toString())}},setItemOptions:$,setIsGrossDisabled:x,setIsTareDisabled:n,setShowInward:v,setShowOutward:m}},fe="Weight Bridge",F="Weight Bridge",ce=["date","display_data","wbslip_type","company","purchase_order","supplier_name","vehicle_no","transporter","ref_no","delivery_note","customer_name","vehicle","item","deduct_reason","gross_weight_date_time","tare_weight_date_time","gross_weight","tare_weight","net_weight","deduct","grand_net_weight","gross","tare","amended_from"],de=["gross","tare"],me=Object.fromEntries([...ce,...de].map(D=>[D,""]));me.wbslip_type="Inward";me.date=new Date().toISOString().split("T")[0];function Xe(){const{isDark:D,darkColorScheme:pe,lightColorScheme:ue}=ye(),c=Ne(),{id:u}=be(),{data:x,isFetching:z}=De({doctype:F,fields:JSON.stringify([...ce,...de])}),{data:n,isFetching:J}=xe({doctype:F,id:u,fields:JSON.stringify([...ce,...de])}),v=We(s=>{s&&(W(),c(-1))}),K=Te(s=>{s&&(W(),c(-1))}),{register:m,handleSubmit:U,formState:{errors:$},control:d,reset:W,setValue:g,watch:G}=_e({resolver:ve(Se(x==null?void 0:x.fields)),defaultValues:u?n:me});r.useEffect(()=>{n&&u&&W(n)},[n,u,W]);const T=I({control:d,name:"wbslip_type"}),q=I({control:d,name:"purchase_order"}),L=I({control:d,name:"delivery_note"}),{isGrossDisabled:P,isTareDisabled:R,showInward:M,showOutward:H,itemOptions:Q,wbslipTypeOptions:X,deductReasonOptions:Y,purchaseOrderOptions:Z,supplierOptions:ee,transporterOptions:se,deliveryNoteOptions:he,customerOptions:S,vehicleOptions:te,displayData:ae,isWeighScaleEnabled:re,purchaseOrderData:j,deliveryNoteData:O,handleWBSlipTypeChange:B,handleGrossWeight:ge,handleTareWeight:le,calculateWeight:ie,setIsGrossDisabled:N,setIsTareDisabled:E,setShowInward:C,setShowOutward:k}=Ee(u,q,L,x);r.useEffect(()=>{n&&u&&(n.gross_weight&&N(!0),n.tare_weight&&E(!0),n.wbslip_type==="Inward"?(C(!0),k(!1)):n.wbslip_type==="Outward"?(C(!1),k(!0)):n.wbslip_type==="Other"&&(C(!0),k(!0)))},[n,u,N,E,C,k]);const ne=I({control:d,name:"gross_weight"}),oe=I({control:d,name:"tare_weight"}),l=I({control:d,name:"deduct"});r.useEffect(()=>{ie(ne,oe,l,g)},[ne,oe,l,g,ie]),r.useEffect(()=>{B(T)},[T,B]),r.useEffect(()=>{u||(T||g("wbslip_type","Inward"),G("date")||g("date",new Date().toISOString().split("T")[0]))},[u,T,g,G]);const f=()=>{ge(g)},o=()=>{le(g)};r.useEffect(()=>{j&&g("supplier_name",j.supplier_name)},[j,g]),r.useEffect(()=>{O&&(g("customer_name",O.customer),g("vehicle",O.custom_vehicle))},[O,g]);const p=s=>{u?K.mutate({doctype:F,body:{...s,id:u}}):v.mutate({doctype:F,body:s})};return z||J?e.jsx(we,{style:{"--sk-color":D?pe[700]:ue[300]}}):e.jsx(Oe,{title:(u?"Edit ":"New ")+fe,children:e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ie,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[u?"Edit":"New"," ",fe]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(V,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>c(-1),children:"Back"}),e.jsx(V,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",children:"Save"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:U(p),id:"new-post-form",children:e.jsxs(je,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Date"}),e.jsx(y,{...m("date"),type:"date",className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Display Data"}),e.jsxs("div",{className:"relative",children:[e.jsx(y,{value:ae,className:"w-full bg-purple-50 text-center text-lg font-mono font-bold",placeholder:"",readOnly:!0}),re&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"wbslip_type",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"WBSlip Type",lists:X,placeholder:"Select Type"})})})]}),M&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Inward"}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"purchase_order",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Purchase Order",lists:Z,placeholder:"Select Purchase Order"})})}),e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"supplier_name",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Supplier Name",lists:ee,placeholder:"Select Supplier"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Vehicle No"}),e.jsx(y,{...m("vehicle_no"),className:"w-full",placeholder:""})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"transporter",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Transporter",lists:se,placeholder:"Select Transporter"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Ref No"}),e.jsx(y,{...m("ref_no"),className:"w-full",placeholder:""})]})]})]}),H&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Outward"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"delivery_note",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Delivery Note",lists:he,placeholder:"Select Delivery Note"})})}),e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"customer_name",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Customer Name",lists:S,placeholder:"Select Customer"})})}),e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"vehicle",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Vehicle",lists:te,placeholder:"Select Vehicle"})})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"item",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Item",lists:Q,placeholder:"Select Item"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Gross Weight Date Time"}),e.jsx(y,{...m("gross_weight_date_time"),type:"datetime-local",className:"w-full",placeholder:"",readOnly:!0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Asia/Kolkata"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Gross Weight"}),e.jsx(y,{...m("gross_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Deduct %"}),e.jsx(y,{...m("deduct"),type:"number",step:"0.01",className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:" "}),e.jsx(V,{type:"button",onClick:f,disabled:P,className:`w-full ${P?"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed":"bg-green-100 text-green-700 border-green-300 hover:bg-green-200"}`,variant:"outlined",children:"Gross"})]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(b,{name:"deduct_reason",control:d,render:({field:{onChange:s,value:a,...h}})=>e.jsx(w,{onChange:s,value:a,label:"Deduct Reason",lists:Y,placeholder:"Select"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Tare Weight Date Time"}),e.jsx(y,{...m("tare_weight_date_time"),type:"datetime-local",className:"w-full",placeholder:"",readOnly:!0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Asia/Kolkata"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Tare Weight"}),e.jsx(y,{...m("tare_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Grand Net Weight"}),e.jsx(y,{...m("grand_net_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:" "}),e.jsx(V,{type:"button",onClick:o,disabled:R,className:`w-full ${R?"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed":"border-dashed border-gray-300 text-gray-600 hover:bg-gray-50"}`,variant:"outlined",children:"Tare"})]})]}),e.jsx("div",{className:"grid grid-cols-5 gap-4",children:e.jsxs("div",{className:"col-span-2 col-start-3 space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Net Weight"}),e.jsx(y,{...m("net_weight"),className:"w-full",placeholder:"",readOnly:!0})]})})]})]})})]})})}export{Xe as default};
