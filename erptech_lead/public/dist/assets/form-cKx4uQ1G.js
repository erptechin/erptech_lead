import{a as i,p as ee,j as e,C as G,B as m,q as ve,s as Ne,t as ae,v as g,w as _e,x as h,l as F,J as H,I as T,U as se,A as re,y as j,z as Ce,D as we,u as De,k as Fe,E as Se,S as Ae}from"./index-Dw_aqVL9.js";import{u as Oe,o as Ee}from"./index.esm-CE7A4dfo.js";import{F as te,S as z,a as le,b as Pe,D as ne}from"./dynamicForms-DTMs2g8J.js";import{P as Me}from"./Page-DlHC0YsZ.js";import{a as Te,b as xe,c as pe,d as ze,u as $e,e as Je}from"./useApiHook-BqvjBvYw.js";import{F as Re,C as Ie}from"./CarProfiles-KWqIoVlh.js";import{C as Ue}from"./ConfirmModal-DWfB4zAP.js";import{F as qe,a as Le}from"./TrashIcon-DOziGx5V.js";import{z as ie,F as $}from"./transition-B3YjhkUm.js";import{y as oe,j as ce}from"./iconBase-ISIPuIcZ.js";import{F as Ve}from"./DocumentPlusIcon-D1HQjByp.js";import"./Datepicker-C5D5GBHa.js";import"./combobox-DO331uC_.js";import"./use-by-comparator-DqVcnxyo.js";import"./hidden-DIZPa8be.js";import"./active-element-history-hm4zKhv1.js";import"./calculate-active-index-RF_ATTLX.js";import"./use-tree-walker-DzYWpzb-.js";import"./frozen-Dtt3oMGs.js";import"./label-d2fDbRp6.js";import"./useMutation-Bccq_1rh.js";import"./floating-ui.dom-CtcSe9Ld.js";function We({id:c,data:r,setValue:K,refetchData:S,filterBy:l="lead",customerId:x=null}){const[U,n]=i.useState(!1),[q,f]=i.useState(!1),[A,y]=i.useState(null),[O,v]=i.useState(!1),[N,b]=i.useState(null),[_,L]=i.useState([]),[E,k]=i.useState([]),V=l==="customer"?"customer":"lead",p=l==="customer"&&(x||(r==null?void 0:r.name))||c,W=l==="customer"?x||(r==null?void 0:r.name)||c:(r==null?void 0:r.customer)||"",[s,o]=i.useState({lead:l==="lead"?c:(r==null?void 0:r.lead_name)||"",customer:W,car_profile:"",approval_manager:"",policy_name:"",policy_amount:"",status:"Waiting",type:"Endorsement",file_attachment:"",comments:""}),[ue,ge]=i.useState({doctype:"Management",page:1,page_length:100,fields:JSON.stringify(["name","lead","customer","car_profile","approval_manager","policy_name","policy_amount","status","file_attachment","comments","creation","modified"]),filters:p?JSON.stringify([[V,"=",p],["type","!=","New"]]):null}),{data:C,isFetching:he,refetch:w}=Te(ue);i.useEffect(()=>{if(p){const a=[["customer","=",p],["status","=","Active"]];ee({doctype:"Car Profile",fields:JSON.stringify(["name","car_make","car_model","car_year"]),filters:JSON.stringify(a),page_length:100}).then(t=>{if(t!=null&&t.data){const D=t.data.map(u=>({label:`${u.car_make||""} ${u.car_model||""} ${u.car_year||""}`.trim()||u.name,value:u.name}));L(D)}}),ee({doctype:"User",fields:JSON.stringify(["name","full_name"]),filters:JSON.stringify([["role_profile_name","=","Lead Manager"]]),page_length:100}).then(t=>{if(t!=null&&t.data){const D=t.data.map(u=>({label:`${u.full_name||""}`.trim()||u.name,value:u.name}));k(D)}})}},[p,l]),i.useEffect(()=>{p&&ge(a=>({...a,filters:JSON.stringify([[V,"=",p],["type","!=","New"]])}))},[p,V]),i.useEffect(()=>{C!=null&&C.data?Q(C.data):Q([])},[C]);const[P,Q]=i.useState([]),[X,Y]=i.useState(!1),[Z,B]=i.useState(!1);xe(a=>{a&&(n(!1),d(),w())}),pe(a=>{a&&(f(!1),y(null),d(),w())});const M=ze(a=>{a&&a.success&&(v(!1),b(null),w())}),d=()=>{o({lead:l==="lead"?c:(r==null?void 0:r.lead_name)||"",customer:W,car_profile:"",approval_manager:"",policy_name:"",policy_amount:"",status:"Waiting",type:"Endorsement",file_attachment:"",comments:""})},fe=async()=>{if(!s.file_attachment){j({message:"File attachment is required"});return}const a={...s};l==="customer"&&!a.lead&&(r!=null&&r.lead)&&(a.lead=r.lead),Y(!0);try{const t=await Ce(a);t&&t.cod_id?(n(!1),d(),w()):j({message:"Failed to create Management"})}catch(t){console.error("Error creating Management:",t),j(t)}finally{Y(!1)}},ye=a=>{const t=P.find(D=>D.name===a);t&&(o({lead:t.lead||(l==="lead"?c:"")||"",customer:t.customer||W||"",car_profile:t.car_profile||"",approval_manager:t.approval_manager||"",policy_name:t.policy_name||"",policy_amount:t.policy_amount||"",status:t.status||"Waiting",type:"Endorsement",file_attachment:t.file_attachment||"",comments:t.comments||""}),y(a),f(!0))},ke=async()=>{if(!A){j({message:"Management ID is required"});return}if(!s.file_attachment){j({message:"File attachment is required"});return}B(!0);try{const a=await we(A,s);a&&a.cod_id?(f(!1),y(null),d(),w()):j({message:"Failed to update Management"})}catch(a){console.error("Error updating Management:",a),j(a)}finally{B(!1)}},je=a=>{b(a),v(!0)},be=()=>{N&&M.mutate({doctype:"Management",ids:[N]})};return i.useEffect(()=>{const a=l==="customer"?x||(r==null?void 0:r.name)||c:(r==null?void 0:r.customer)||"";a&&o(t=>({...t,customer:a}))},[r==null?void 0:r.customer,x,l,c,r==null?void 0:r.name]),p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"col-span-12 lg:col-span-12",children:e.jsx(G,{className:"p-4 sm:px-5",children:e.jsxs("div",{className:"mt-5 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Endorsement Approvals"}),e.jsxs(m,{onClick:()=>{d(),n(!0)},color:"primary",className:"flex items-center gap-2",children:[e.jsx(Re,{className:"size-4"}),"Approvals Request"]})]}),he?e.jsx("div",{className:"py-4 text-center text-sm text-gray-500",children:"Loading Endorsement..."}):P&&P.length>0?e.jsx("div",{className:"mt-6",children:e.jsx("div",{className:"hide-scrollbar overflow-x-auto",children:e.jsxs(ve,{hoverable:!0,className:"w-full min-w-[900px] text-left rtl:text-right",children:[e.jsx(Ne,{children:e.jsxs(ae,{className:"border-y border-transparent border-b-gray-200 dark:border-b-dark-500",children:[e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Customer"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Car Profile"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Policy Name"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Policy Amount"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Status"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Approval Manager"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"File Attachment"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Comments"}),e.jsx(g,{className:"bg-gray-200 font-semibold uppercase text-gray-800 dark:bg-dark-800 dark:text-dark-100",children:"Actions"})]})}),e.jsx(_e,{children:P.map(a=>e.jsxs(ae,{className:"border-b border-gray-200 dark:border-dark-500",children:[e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.customer||"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.car_profile||"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.policy_name||"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.policy_amount?`AED ${parseFloat(a.policy_amount).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:e.jsx("span",{className:F("inline-flex rounded-full px-2 py-1 text-xs font-semibold",a.status==="Approve"&&"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",a.status==="Decline"&&"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",a.status==="Waiting"&&"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400"),children:a.status||"-"})}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.approval_manager||"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.file_attachment?e.jsx("a",{href:`${H}${a.file_attachment}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline dark:text-blue-400",children:"View File"}):"-"}),e.jsx(h,{className:"text-gray-700 dark:text-dark-200",children:a.comments||"-"}),e.jsx(h,{children:a.status!=="Approve"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{size:"sm",variant:"outlined",onClick:()=>ye(a.name),className:"p-1.5",children:e.jsx(qe,{className:"size-4"})}),e.jsx(m,{size:"sm",variant:"outlined",color:"error",onClick:()=>je(a.name),className:"p-1.5",disabled:M.isPending,children:e.jsx(Le,{className:"size-4"})})]})})]},a.name))})]})})}):e.jsx("div",{className:"flex flex-col items-center justify-center py-12",children:e.jsx("p",{className:"text-gray-500 dark:text-dark-300",children:'No Endorsement yet. Click "Add New Record" to add one.'})})]})})}),e.jsxs(ie,{appear:!0,show:U,as:oe,onClose:()=>{n(!1),d()},children:[e.jsx($,{as:"div",enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",className:"fixed inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"}),e.jsx($,{as:ce,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"fixed inset-0 z-100 flex items-center justify-center overflow-hidden px-4 py-6 sm:px-5",children:e.jsxs("div",{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col rounded-lg bg-white transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Add Approvals Request"}),e.jsx("button",{onClick:()=>{n(!1),d()},className:"rounded-lg p-1.5 hover:bg-gray-100 dark:hover:bg-dark-600",children:e.jsx(te,{className:"size-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(z,{label:"Car Profile",lists:_,value:s.car_profile,onChange:a=>o({...s,car_profile:a||""}),placeholder:"Select Car Profile",req:!0})}),e.jsx("div",{children:e.jsx(z,{label:"Approval Manager",lists:E,value:s.approval_manager,onChange:a=>o({...s,approval_manager:a||""}),placeholder:"Select Approval Manager",req:!0})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["Policy Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(T,{value:s.policy_name,onChange:a=>o({...s,policy_name:a.target.value}),placeholder:"Enter Policy Name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Amount"}),e.jsx(T,{type:"number",value:s.policy_amount,onChange:a=>o({...s,policy_amount:a.target.value}),placeholder:"Enter Policy Amount",step:"0.01",min:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["File Attachment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(se,{onChange:a=>{a&&o({...s,file_attachment:a})},children:({...a})=>e.jsxs(m,{...a,unstyled:!0,className:F("mt-3 w-full shrink-0 flex-col rounded-lg border-2 border-dashed py-10 border-gray-300 dark:border-dark-450"),children:[e.jsx(le,{className:"size-12"}),e.jsxs("span",{className:F("pointer-events-none mt-2 text-gray-600 dark:text-dark-200"),children:[e.jsx("span",{className:"text-primary-600 dark:text-primary-400",children:"Browse"}),e.jsx("span",{children:" or drop your files here"})]}),s.file_attachment&&e.jsx("span",{className:"mt-2 text-sm text-gray-500 dark:text-dark-300",children:"File selected"})]})}),s.file_attachment&&e.jsx("div",{className:"mt-2 flex flex-col space-y-4",children:e.jsx("div",{className:"relative inline-block",children:e.jsx(re,{size:24,src:`${H}${s.file_attachment}`,classNames:{display:"rounded-lg"}})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Comments"}),e.jsx("textarea",{value:s.comments,onChange:a=>o({...s,comments:a.target.value}),placeholder:"Enter comments...",rows:"3",className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50"})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx(m,{variant:"outlined",onClick:()=>{n(!1),d()},children:"Cancel"}),e.jsx(m,{color:"primary",onClick:fe,disabled:!s.file_attachment||X,children:X?"Adding...":"Add Document"})]})]})})]}),e.jsxs(ie,{appear:!0,show:q,as:oe,onClose:()=>{f(!1),y(null),d()},children:[e.jsx($,{as:"div",enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",className:"fixed inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"}),e.jsx($,{as:ce,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",className:"fixed inset-0 z-100 flex items-center justify-center overflow-hidden px-4 py-6 sm:px-5",children:e.jsxs("div",{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col rounded-lg bg-white transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-dark-50",children:"Edit Endorsement"}),e.jsx("button",{onClick:()=>{f(!1),y(null),d()},className:"rounded-lg p-1.5 hover:bg-gray-100 dark:hover:bg-dark-600",children:e.jsx(te,{className:"size-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(z,{label:"Car Profile",lists:_,value:s.car_profile,onChange:a=>o({...s,car_profile:a||""}),placeholder:"Select Car Profile"})}),e.jsx("div",{children:e.jsx(z,{label:"Approval Manager",lists:E,value:s.approval_manager,onChange:a=>o({...s,approval_manager:a||""}),placeholder:"Select Approval Manager"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Name"}),e.jsx(T,{value:s.policy_name,onChange:a=>o({...s,policy_name:a.target.value}),placeholder:"Enter Policy Name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Policy Amount"}),e.jsx(T,{type:"number",value:s.policy_amount,onChange:a=>o({...s,policy_amount:a.target.value}),placeholder:"Enter Policy Amount",step:"0.01",min:"0"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:["File Attachment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(se,{onChange:a=>{a&&o({...s,file_attachment:a})},children:({...a})=>e.jsxs(m,{...a,unstyled:!0,className:F("mt-3 w-full shrink-0 flex-col rounded-lg border-2 border-dashed py-10 border-gray-300 dark:border-dark-450"),children:[e.jsx(le,{className:"size-12"}),e.jsxs("span",{className:F("pointer-events-none mt-2 text-gray-600 dark:text-dark-200"),children:[e.jsx("span",{className:"text-primary-600 dark:text-primary-400",children:"Browse"}),e.jsx("span",{children:" or drop your files here"})]}),s.file_attachment&&e.jsx("span",{className:"mt-2 text-sm text-gray-500 dark:text-dark-300",children:"File selected"})]})}),s.file_attachment&&e.jsx("div",{className:"mt-2 flex flex-col space-y-4",children:e.jsx("div",{className:"relative inline-block",children:e.jsx(re,{size:24,src:`${H}${s.file_attachment}`,classNames:{display:"rounded-lg"}})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-dark-100",children:"Comments"}),e.jsx("textarea",{value:s.comments,onChange:a=>o({...s,comments:a.target.value}),placeholder:"Enter comments...",rows:"3",className:"w-full rounded-lg border border-gray-300 px-3 py-2 dark:border-dark-400 dark:bg-dark-500 dark:text-dark-50"})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 border-t border-gray-200 px-5 py-4 dark:border-dark-500",children:[e.jsx(m,{variant:"outlined",onClick:()=>{f(!1),y(null),d()},children:"Cancel"}),e.jsx(m,{color:"primary",onClick:ke,disabled:!s.file_attachment||Z,children:Z?"Updating...":"Update Document"})]})]})})]}),e.jsx(Ue,{show:O,onClose:()=>{v(!1),b(null)},onOk:be,confirmLoading:M.isPending,state:M.isError?"error":"pending",messages:{pending:{title:"Delete Endorsement?",description:"Are you sure you want to delete this Endorsement? This action cannot be undone.",actionText:"Delete"}}})]}):null}const de="Customer List",J="Customer",R=["customer_name","customer_type"],I=["customer_primary_address","custom_customer_image"],me={customer_site_addresses:{title:!0,address:!0},ignorFields:{}},He=Object.fromEntries([...R,...I].map(c=>[c,""]));function ga(){const{isDark:c,darkColorScheme:r,lightColorScheme:K}=De(),S=Fe(),{id:l}=Se(),{data:x,isFetching:U}=$e({doctype:J,fields:JSON.stringify([...R,...I])}),{data:n,isFetching:q,refetch:f}=Je({doctype:J,id:l,fields:JSON.stringify([...R,...I])}),A=xe(k=>{k&&(_(),S(-1))}),y=pe(k=>{k&&(_(),S(-1))}),{register:O,handleSubmit:v,formState:{errors:N},control:b,reset:_,setValue:L}=Oe({resolver:Ee(Pe(x==null?void 0:x.fields)),values:l?n:He}),E=k=>{l?y.mutate({doctype:J,body:{...k,id:l}}):A.mutate({doctype:J,body:k})};return U||q?e.jsx(Ae,{style:{"--sk-color":c?r[700]:K[300]}}):e.jsx(Me,{title:(l?"Edit ":"New ")+de,children:e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ve,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[l?"Edit":"New"," ",de]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>S(-1),children:"Back"}),e.jsx(m,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",children:"Save"})]})]}),e.jsxs("form",{autoComplete:"off",onSubmit:v(E),id:"new-post-form",children:[e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[l&&e.jsx(We,{id:n==null?void 0:n.lead,data:n,setValue:L,refetchData:f,filterBy:"customer",customerId:l}),e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsx(G,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:e.jsx(ne,{infos:x,fields:R,register:O,tables:me,control:b,errors:N})})})}),e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-4 lg:space-y-6",children:e.jsx(G,{className:"p-4 sm:px-5",children:e.jsx(ne,{infos:x,tables:me,fields:I,register:O,control:b,errors:N})})})]}),l&&e.jsx("div",{className:"mt-6",children:e.jsx(Ie,{customerId:l,leadId:n==null?void 0:n.lead,customerName:(n==null?void 0:n.customer_name)||(n==null?void 0:n.name)})})]})]})})}export{ga as default};
